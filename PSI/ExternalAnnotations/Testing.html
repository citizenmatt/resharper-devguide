


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper-devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper-devguide/styles/styles.css"></head>
<body data-id="PSI/ExternalAnnotations/Testing">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="testing-external-annotations" class="elem-anchor"></a>
<h1>Testing External Annotations<a href="#testing-external-annotations" class="anchor-link"><span></span></a></h1>

<p>There are two approaches to testing External Annotations. The first is to use the <code class="code highlight language-text">CodeAnnotationsCache</code> class to assert that annotations are applied to specific code elements in the compiled assemblies. The second is to assert the highlights and warnings that are affected by annotations. For example, an element marked with the <code class="code highlight language-text">[NotNull]</code> attribute will cause ReSharper to highlight a null check as unnecessary.</p>

<p>Which method you choose is up to you. The first approach tests that the external annotations are correctly applied, while the second asserts the expected result of applying the annotations. ReSharper doesn’t prescribe a specific approach; there are no base classes or helper methods specifically for testing external annotations. The first approach requires some helper methods, and an example base class is provided below, while the second approach is a normal highlighting test.</p>

<a name="loading-the-annotations" class="elem-anchor"></a>
<h2>Loading the annotations<a href="#loading-the-annotations" class="anchor-link"><span></span></a></h2>

<p>Before any tests can run, the annotations need to be loaded by the test environment. ReSharper doesn’t do this by default, it only loads annotations that are installed with the product, or as extensions. Instead, they have to be loaded explicitly by the test assembly, by implementing <code class="code highlight language-text">IExternalAnnotationsFileProvider</code> and marking the component with the <code class="code highlight language-text">[ShellComponent]</code> attribute.</p>

<p>The following class will load all annotations stored in a specific folder, which, in this example will be <code class="code highlight language-text">test\data\annotations</code>, but by replacing the implementation of <code class="code highlight language-text">RelativeTestDataPath</code> you can change it to another location relative to <code class="code highlight language-text">test\data</code>, even outside of the <code class="code highlight language-text">test\data</code> folder structure. Or you can completely replace <code class="code highlight language-text">BaseTestDataPath</code> to return any location you want.</p>

<p>This provider will load all XML files that are immediate children of the file location. These are expected to be named after the assembly, e.g. <code class="code highlight language-text">myAssembly.dll</code> would need a <code class="code highlight language-text">myAssembly.xml</code> file in the root location. It will also recursively look for any XML files in child directories. Either the directory should be named after the assembly, in which case all files in that directory apply to the assembly, or the file should be named after the assembly. This is the same folder structure and naming scheme used when annotations are distributed inside an extension package.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[ShellComponent]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">TestExternalAnnotationsProvider</span> <span class="p">:</span> <span class="n">IExternalAnnotationsFileProvider</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">OneToSetMap</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">FileSystemPath</span><span class="p">&gt;</span> <span class="n">annotations</span><span class="p">;</span>
  <span class="k">private</span> <span class="n">FileSystemPath</span> <span class="n">cachedBaseTestDataPath</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">TestExternalAnnotationsProvider</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">location</span> <span class="p">=</span> <span class="n">TestDataPath2</span><span class="p">;</span>
    <span class="n">annotations</span> <span class="p">=</span> <span class="k">new</span> <span class="n">OneToSetMap</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">FileSystemPath</span><span class="p">&gt;(</span><span class="n">StringComparer</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="n">location</span><span class="p">.</span><span class="n">GetChildFiles</span><span class="p">(</span><span class="s">&quot;*.xml&quot;</span><span class="p">))</span>
      <span class="n">annotations</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">NameWithoutExtension</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">directory</span> <span class="k">in</span> <span class="n">location</span><span class="p">.</span><span class="n">GetChildDirectories</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="n">directory</span><span class="p">.</span><span class="n">GetChildFiles</span><span class="p">(</span><span class="s">&quot;*.xml&quot;</span><span class="p">,</span> <span class="n">PathSearchFlags</span><span class="p">.</span><span class="n">RecurseIntoSubdirectories</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">annotations</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">NameWithoutExtension</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
        <span class="n">annotations</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">FileSystemPath</span><span class="p">&gt;</span> <span class="n">GetAnnotationsFiles</span><span class="p">(</span><span class="n">AssemblyNameInfo</span> <span class="n">assemblyName</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">FileSystemPath</span> <span class="n">assemblyLocation</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">assemblyName</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">annotations</span><span class="p">.</span><span class="n">Values</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">annotations</span><span class="p">[</span><span class="n">assemblyName</span><span class="p">.</span><span class="n">Name</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="n">FileSystemPath</span> <span class="n">BaseTestDataPath</span>
  <span class="p">{</span>
    <span class="k">get</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cachedBaseTestDataPath</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">cachedBaseTestDataPath</span> <span class="p">=</span> <span class="n">TestUtil</span><span class="p">.</span><span class="n">GetTestDataPathBase</span><span class="p">(</span><span class="n">GetType</span><span class="p">().</span><span class="n">Assembly</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">cachedBaseTestDataPath</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="kt">string</span> <span class="n">RelativeTestDataPath</span>
  <span class="p">{</span>
    <span class="c1">// This can be relative, e.g. @&quot;..\..\ExternalAnnotations&quot;</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="s">@&quot;annotations&quot;</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="n">FileSystemPath</span> <span class="n">TestDataPath2</span>
  <span class="p">{</span>
    <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">BaseTestDataPath</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">RelativeTestDataPath</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<a name="targeting-the-assembly" class="elem-anchor"></a>
<h2>Targeting the assembly<a href="#targeting-the-assembly" class="anchor-link"><span></span></a></h2>

<p>External annotations don’t target source files, but already existing, compiled assemblies. In order to test that annotations are correctly applied, the in-memory, temporary project created by the test environment needs to add references to the target assembly/assemblies.</p>

<p>This is easily done using the <code class="code highlight language-text">[TestReferences]</code> attribute on the test class. The parameters to the attribute are the names of the assemblies to reference. The values can be a filename, or a relative or absolute file path. If the value is a filename or a relative file path, the actual path is resolved against the <code class="code highlight language-text">TestDataPath2</code> property (which resolves to <code class="code highlight language-text">test\data</code> plus the value of <code class="code highlight language-text">RelativeTestDataPath</code>). If the value is an absolute file path, it is used as-is.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[TestReferences(&quot;myAssembly.dll&quot;, &quot;mySupport.dll&quot;)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">MyAssemblyAnnotationsTest</span> <span class="p">:</span> <span class="n">ExternalAnntotionsTestBase2</span>
<span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>

<p>The referenced assembly names can also contain environment variable names, which will be expanded before use. This can be very useful, as environment variables can be set programmatically by overriding the <code class="code highlight language-text">SetUp</code> method. E.g.:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[TestReferences(@&quot;%MY_ASSEMBLY_PATH%\myAssembly.dll&quot;)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">MyAssemblyAnnotationsTest</span> <span class="p">:</span> <span class="n">ExternalAnnotationsTestBase2</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">SetUp</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="n">SetUp</span><span class="p">();</span>

    <span class="n">Environment</span><span class="p">.</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s">&quot;MY_ASSEMBLY_PATH&quot;</span><span class="p">,</span> <span class="n">BaseTestDataPath</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="s">&quot;lib&quot;</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>If you need more control over the references you’re adding, you can override the <code class="code highlight language-text">BaseTestWithSingleProject.GetReferencedAssemblies</code> method.</p>

<aside class="note">
  <p> Remember that external annotations can target multiple versions of an assembly by specifying the version in the assembly <code class="code highlight language-text">name</code> attribute in the XML file. To test multiple versions, simply create multiple test classes, each referencing a different version of the target assembly. If the multiple versions share test cases, they can implemented in a base class and shared via inheritance.</p>

  <p>If using base classes, the <code class="code highlight language-text">TestReferencesAttribute.Inherits</code> property declares whether <code class="code highlight language-text">TestReferences</code> attributes on the base class are used or not. By default, they aren’t - the <code class="code highlight language-text">TestReferences</code> attribute of declared classes override the base class.</p>
</aside>

<a name="testing-applied-annotations" class="elem-anchor"></a>
<h2>Testing applied annotations<a href="#testing-applied-annotations" class="anchor-link"><span></span></a></h2>

<p>The following code snippet defines a class called <code class="code highlight language-text">ExternalAnnotationsTestBase2</code> which provides a helper method to convert an XML Doc ID to an <code class="code highlight language-text">IDeclaredElement</code>. It then gets an instance of <code class="code highlight language-text">CodeAnnotationsCache</code> and both are passed to the assert method, which can use the cache to ask for the annotations applied to the given code element.</p>

<aside class="note">
  <p> ReSharper already defines a class called <code class="code highlight language-text">ExternalAnnotationsTestBase</code> that provides similar functionality used internally for testing external annotations. However, it is unsuitable to use as a base class for plugin tests, as it defines tests for the standard BCL annotations, which would also run for your plugin tests.</p>
</aside>

<p>The base class looks like this:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ExternalAnnotationsTestBase2</span> <span class="p">:</span> <span class="n">BaseTestWithSingleProject</span>
<span class="p">{</span>
  <span class="k">protected</span> <span class="k">override</span> <span class="n">RelativeTestDataPath</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">AssertHelper</span><span class="p">(</span><span class="kt">string</span> <span class="n">xmlDocId</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">CodeAnnotationsCache</span><span class="p">,</span> <span class="n">IDeclaredElement</span><span class="p">&gt;</span> <span class="n">assert</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// We&#39;re not checking source files, but referenced assemblies</span>
    <span class="kt">var</span> <span class="n">sourceFiles</span> <span class="p">=</span> <span class="n">EmptyList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="n">InstanceList</span><span class="p">;</span>

    <span class="n">WithSingleProject</span><span class="p">(</span><span class="n">sourceFiles</span><span class="p">,</span> <span class="p">(</span><span class="n">lifetime</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="n">RunGuarded</span><span class="p">(()</span> <span class="p">=&gt;</span>
      <span class="p">{</span>
        <span class="kt">var</span> <span class="n">psiModule</span> <span class="p">=</span> <span class="n">solution</span><span class="p">.</span><span class="n">PsiModules</span><span class="p">().</span><span class="n">GetPrimaryPsiModule</span><span class="p">(</span><span class="n">project</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">psiServices</span> <span class="p">=</span> <span class="n">solution</span><span class="p">.</span><span class="n">GetPsiServices</span><span class="p">();</span>

        <span class="c1">// Get the IDeclaredElement from the XML Doc ID</span>
        <span class="kt">var</span> <span class="n">declaredElement</span> <span class="p">=</span> <span class="n">XMLDocUtil</span><span class="p">.</span><span class="n">ResolveId</span><span class="p">(</span><span class="n">psiServices</span><span class="p">,</span> <span class="n">xmlDocId</span><span class="p">,</span> <span class="n">psiModule</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="n">project</span><span class="p">.</span><span class="n">GetResolveContext</span><span class="p">();</span>
        <span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">declaredElement</span><span class="p">,</span> <span class="s">&quot;Declared element cannot be resolved from XMLDocID {0}&quot;</span><span class="p">,</span> <span class="n">xmlDocId</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">annotationsCache</span> <span class="p">=</span> <span class="n">psiServices</span><span class="p">.</span><span class="n">GetAnnotationsCache</span><span class="p">();</span>

        <span class="n">assert</span><span class="p">(</span><span class="n">annotationsCache</span><span class="p">,</span> <span class="n">declaredElement</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">void</span> <span class="nf">AssertMeansImplicitUseAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">xmlDocId</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">AssertHelper</span><span class="p">(</span><span class="n">xmlDocId</span><span class="p">,</span> <span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">attributesOwner</span> <span class="p">=</span> <span class="n">element</span> <span class="k">as</span> <span class="n">IAttributesOwner</span><span class="p">;</span>
      <span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">attributesOwner</span><span class="p">,</span> <span class="s">&quot;Declared element is not an IAttributesOwner {0}&quot;</span><span class="p">,</span> <span class="n">xmlDocId</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">attributeInstances</span> <span class="p">=</span> <span class="n">attributesOwner</span><span class="p">.</span><span class="n">GetAttributeInstances</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">attributeInstance</span> <span class="k">in</span> <span class="n">attributeInstances</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ImplicitUseKindFlags</span> <span class="n">kindFlags</span><span class="p">;</span>
        <span class="n">ImplicitUseTargetFlags</span> <span class="n">targetFlags</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">.</span><span class="n">IsMeansImplicitUse</span><span class="p">(</span><span class="n">attributeInstance</span><span class="p">,</span> <span class="k">out</span> <span class="n">kindFlags</span><span class="p">,</span> <span class="k">out</span> <span class="n">targetFlags</span><span class="p">))</span>
          <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">Assert</span><span class="p">.</span><span class="n">Fail</span><span class="p">(</span><span class="s">&quot;Declared element is not marked as implicit use {0}&quot;</span><span class="p">,</span> <span class="n">xmlDocId</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">void</span> <span class="nf">AssertParameterAssertCondition</span><span class="p">(</span><span class="kt">string</span> <span class="n">xmlDocId</span><span class="p">,</span> <span class="kt">string</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">AssertConditionType</span><span class="p">?</span> <span class="n">conditionType</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">AssertHelper</span><span class="p">(</span><span class="n">xmlDocId</span><span class="p">,</span> <span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">parametersOwner</span> <span class="p">=</span> <span class="n">element</span> <span class="k">as</span> <span class="n">IParametersOwner</span><span class="p">;</span>
      <span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">parametersOwner</span><span class="p">,</span> <span class="s">&quot;Declared element is not an IParametersOwner {0}&quot;</span><span class="p">,</span> <span class="n">xmlDocId</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">parameter</span> <span class="p">=</span> <span class="n">parametersOwner</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">SingleOrDefault</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">ShortName</span> <span class="p">==</span> <span class="n">parameterName</span><span class="p">);</span>
      <span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="s">&quot;Parameter \&quot;{0}\&quot; is not found on {1}&quot;</span><span class="p">,</span> <span class="n">parameterName</span><span class="p">,</span> <span class="n">xmlDocId</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">actual</span> <span class="p">=</span> <span class="n">cache</span><span class="p">.</span><span class="n">GetParameterAssertionCondition</span><span class="p">(</span><span class="n">parameter</span><span class="p">);</span>
      <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">conditionType</span><span class="p">,</span> <span class="n">actual</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>Other assert methods can be added similar to <code class="code highlight language-text">AssertParameterAssertCondition</code> that also call into <code class="code highlight language-text">CodeAnnotationsCache</code> in order to assert annotations are applied.</p>

<aside class="note">
  <p> The prefix in the name of the XML Doc ID identifies the type of the code element - <code class="code highlight language-text">T</code> for type, <code class="code highlight language-text">M</code> for method, <code class="code highlight language-text">P</code> for property and so on. See the <a href="http://msdn.microsoft.com/en-us/library/fsbx0t7x.aspx" data-bypass="yes"><span>MSDN documentation on XML Doc IDs</span></a> for more details.</p>
</aside>

<!-- Comment to separate the notes -->

<aside class="warning">
  <p> This approach requires that ReSharper can resolve the types and constructors of the <code class="code highlight language-text">JetBrains.Annotations</code> attributes referenced in the external annotations file. If ReSharper cannot resolve these types, the annotations are not applied, and tests can fail.</p>

  <p>ReSharper can automatically resolve types against the <code class="code highlight language-text">JetBrains.Annotations.dll</code> assembly in the product install directory (by using a custom <code class="code highlight language-text">IPsiModule</code>). In normal usage, this effectively means all projects can resolve references to the annotation attributes.</p>

  <p>However, in tests, the product directory is the location of the test assembly, and the <code class="code highlight language-text">JetBrains.Annotations.dll</code> assembly is not referenced in a test project, and therefore not copied to the <code class="code highlight language-text">bin\Debug</code> folder. (It is not referenced simply because ReSharper itself doesn’t include any binary references to the <code class="code highlight language-text">.dll</code> to prevent versioning conflicts when multiple products are installed.)</p>

  <p>This can be fixed in a couple of ways. Firstly, add a reference to <code class="code highlight language-text">JetBrains.Annotations.dll</code> in your plugin test project, or a custom post-build step that copies <code class="code highlight language-text">$(ReSharperSdkBinaries)\JetBrains.Annotations.dll</code> to the output folder.</p>

  <p>Secondly, add <code class="code highlight language-text">JetBrains.Annotations.dll</code> to the <code class="code highlight language-text">[TestReferences]</code> attribute, and place a copy in the appropriate <code class="code highlight language-text">test\data</code> location (<code class="code highlight language-text">TestDataPath2</code> + <code class="code highlight language-text">RelativeTestDataPath</code>).</p>

  <p>Alternatively, add a C# source file to the temporary, in-memory test project that contains the source of the annotation attributes. The file will live in the location represented by <code class="code highlight language-text">TestDataPath2</code> and <code class="code highlight language-text">RelativeTestDataPath</code> (e.g. <code class="code highlight language-text">&quot;test\data\&quot;</code> + <code class="code highlight language-text">RelativeTestDataPath</code>). The contents of the file come from ReSharper’s options dialog (ReSharper » Options » Code Inspection » Code Annotations » Copy default implementation to clipboard).</p>

  <p>This approach works well, except the source file doesn’t contain all annotations - older, obsolete annotations are not included (for example, <code class="code highlight language-text">AssertionConditionAttribute</code>, while still supported, is not included in the default implementation, as it has been replaced by the more versatile <code class="code highlight language-text">ContractAnnotationAttribute</code>). If you require the older annotations, add a binary reference.</p>
</aside>

<a name="testing-warnings-and-highlights" class="elem-anchor"></a>
<h2>Testing warnings and highlights<a href="#testing-warnings-and-highlights" class="anchor-link"><span></span></a></h2>

<p>Instead of testing that the annotations are applied to members, you can also test the highlights generated (or not) in response to the annotations, by deriving from <code class="code highlight language-text">HighlightingTestBase</code> or one of its derived types, such as <code class="code highlight language-text">CSharpHighlightingTestBase</code>.</p>

<p>This is a simple highlighting test, which analyses a source file and creates a temporary file that contains the text of the original file, plus a list of all highlights that are applied (if any). If the analysis is affected by external annotations, such as a <code class="code highlight language-text">[NotNull]</code> annotation, extra highlights can be applied to the code that wouldn’t be applied if the annotations weren’t there. The temporary file, with the list of highlights, is compared to a previously stored ‘gold’ file. If it differs, the test fails.</p>

<p>The tests can be run with the <code class="code highlight language-text">DoOneTest</code> method, where the name of the source file is passed in, or by using the <code class="code highlight language-text">DoNamedTest2</code> method, which takes the file name from the test method, minus any ‘test’ prefix.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Should_show_annotations</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Looks for &#39;MyAnnotations.cs&#39;. The &#39;.cs&#39; is added automatically</span>
  <span class="n">DoOneTest</span><span class="p">(</span><span class="s">&quot;MyAnnotations&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">TestMyAnnotations</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">DoNamedTest2</span><span class="p">();</span> <span class="c1">// Looks for &#39;MyAnnotations.cs&#39;</span>
<span class="p">}</span></code></pre>

<p>You might prefer to use this method over checking the annotations are applied as it checks the outcome of the annotation, rather than just that the annotation is applied. While this approach initially seems easier, it should be noted that each test requires a new source file for each scenario. The first approach, while requiring extra initial set up for creating the base class and importing <code class="code highlight language-text">JetBrains.Annotations.dll</code>, makes each test a simple call to a helper method to assert the annotation. This might be easier if you have many annotations you wish to test.</p>



                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper-devguide/app/js/main.build" data-baseurl="/resharper-devguide/" src="/resharper-devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

