


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper/devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper/devguide/styles/styles.css"></head>
<body data-id="PSI/Reference/Xml/Manipulation">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="manipulating-the-tree" class="elem-anchor"></a>
<h1>Manipulating the Tree<a href="#manipulating-the-tree" class="anchor-link"><span></span></a></h1>

<p>The XML PSI tree doesn’t provide many strongly typed methods for manipulating the tree. The <a href="TreeNodes.html#ixmltag"><span><code class="code highlight language-text">IXmlTag</code></span></a> and <a href="TreeNodes.html#ixmltagcontainer"><span><code class="code highlight language-text">IXmlTagContainer</code></span></a> nodes are the only ones that provide methods.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="n">inteface</span> <span class="n">IXmlTag</span>
<span class="p">{</span>
  <span class="c1">// ...snip...</span>

  <span class="n">TXmlAttribute</span> <span class="n">AddAttributeAfter</span><span class="p">&lt;</span><span class="n">TXmlAttribute</span><span class="p">&gt;(</span><span class="n">TXmlAttribute</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">IXmlAttribute</span> <span class="n">anchor</span><span class="p">);</span>
  <span class="n">TXmlAttribute</span> <span class="n">AddAttributeBefore</span><span class="p">&lt;</span><span class="n">TXmlAttribute</span><span class="p">&gt;(</span><span class="n">TXmlAttribute</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">IXmlAttribute</span> <span class="n">anchor</span><span class="p">);</span>
  <span class="k">void</span> <span class="nf">RemoveAttribute</span><span class="p">(</span><span class="n">IXmlAttribute</span> <span class="n">attribute</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IXmlTagContainer</span>
<span class="p">{</span>
  <span class="c1">// ...snip...</span>
  <span class="n">TXmlTag</span> <span class="n">AddTagAfter</span><span class="p">&lt;</span><span class="n">TXmlTag</span><span class="p">&gt;(</span><span class="n">TXmlTag</span><span class="p">,</span> <span class="n">IXmlTag</span> <span class="n">anchor</span><span class="p">);</span>
  <span class="n">TXmlTag</span> <span class="n">AddTagBefore</span><span class="p">&lt;</span><span class="n">TXmlTag</span><span class="p">&gt;(</span><span class="n">TXmlTag</span><span class="p">,</span> <span class="n">IXmlTag</span> <span class="n">anchor</span><span class="p">);</span>
<span class="p">}</span></code></pre>

<p>Both interfaces allow adding an attribute or a tag, specifying an <code class="code highlight language-text">anchor</code> tree node that should be used to insert before or after. This <code class="code highlight language-text">anchor</code> node can be null, in which case, the <code class="code highlight language-text">*After</code> methods will add the new attribute or tag <strong>before</strong> all other nodes, and the <code class="code highlight language-text">*Before</code> methods will add it <strong>after</strong> the other nodes.</p>

<aside class="note">
  <p> This may seem counter-intuitive, but if you want to use the <code class="code highlight language-text">*After</code> methods to add to the end of the current list, you can pass in the node at the end of the list. Without this <code class="code highlight language-text">null</code> handling, there is no way to add an attribute to the start of the list using the <code class="code highlight language-text">*After</code> methods, and you would have to introduce special case handling.</p>
</aside>

<a name="util-classes" class="elem-anchor"></a>
<h2>Util classes<a href="#util-classes" class="anchor-link"><span></span></a></h2>

<p>While the tree nodes don’t provide any more methods for manipulating the tree, the <a href="Utils.html"><span>Util classes</span></a> do. Specifically, <a href="Utils.html#xmlattributeutil"><span><code class="code highlight language-text">XmlAttributeUtil</code></span></a> and <a href="Utils.html#xmltagutil"><span><code class="code highlight language-text">XmlTagUtil</code></span></a>.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">XmlAttributeUtil</span>
<span class="p">{</span>
  <span class="c1">// ...snip...</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">SetValue</span><span class="p">(</span><span class="n">IXmlAttribute</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">string</span> <span class="n">unquotedValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">XmlTagUtil</span>
<span class="p">{</span>
  <span class="c1">// ...snip...</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeCompound</span><span class="p">(</span><span class="n">IXmlTag</span> <span class="n">tag</span><span class="p">);</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeEmptyTag</span><span class="p">(</span><span class="n">IXmlTag</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span></code></pre>

<p>The <a href="Utils.html#xmlattributeutil"><span><code class="code highlight language-text">XmlAttributeUtil.SetValue</code></span></a> method sets the value of the attribute to the string passed in. Since there are no methods for manipulating the text of the attribute value, it does this by replacing the <a href="TreeNodes.html#ixmlattributevalue"><span><code class="code highlight language-text">IXmlAttributeValue</code></span></a> node in the given attribute with a new instance.</p>

<p>The <a href="Utils.html#xmltagutil"><span><code class="code highlight language-text">XmlTagUtil</code></span></a> methods rewrite the tree, replacing a tag with an opening and closing element to one which is self-closing, and vice versa.</p>

<a name="removing-nodes" class="elem-anchor"></a>
<h2>Removing nodes<a href="#removing-nodes" class="anchor-link"><span></span></a></h2>

<p>While <code class="code highlight language-text">IXmlTag.RemoveAttribute</code> allows for removing an attribute, there isn’t a method for removing a child tag, or other nodes, such as processing instructions. In this case, <code class="code highlight language-text">ModificationUtil.DeleteChild</code> can be used to remove a specific node, or <code class="code highlight language-text">ModificationUtil.DeleteChildRange</code> to remove a range of nodes.</p>

<aside class="warning">
  <p> When calling <code class="code highlight language-text">ModificationUtil</code> methods, the code expects the caller to have already taken the write lock, if the node being operated on is part of a file. I.e. <code class="code highlight language-text">node.IsPhysical()</code> returns <code class="code highlight language-text">true</code>. The write lock is not needed if the node isn’t part of a file, such as when it has been just created and not yet inserted into the tree, or it has just been removed from the tree.</p>

  <p>The <code class="code highlight language-text">ModificationUtil</code> methods contain an assert that the write lock has been correctly taken, but the assert is disabled in the production build of ReSharper. It is <strong>highly recommended</strong> to install the checked version when developing extensions, so the assert will run, and verify your code.</p>
</aside>

<a name="adding-nodes" class="elem-anchor"></a>
<h2>Adding nodes<a href="#adding-nodes" class="anchor-link"><span></span></a></h2>

<p>Adding a new node is fairly straightforward, in that it’s a simple call to one of the <code class="code highlight language-text">ModificationUtil.AddChild*</code> methods.</p>

<aside class="warning">
  <p> Again, ensure that the write lock is held if calling <code class="code highlight language-text">ModificationUtil.AddChild*</code> on a node that is already part of a file’s tree.</p>
</aside>

<p>Before adding a node, however, it must be created first. The XML PSI has a couple of methods for creating nodes. The <code class="code highlight language-text">XmlElementFactory</code> class can create an instance of <code class="code highlight language-text">IXmlFile</code>, and has methods for creating tags and attributes. It does not provide methods for creating other tree node types. You can use the <code class="code highlight language-text">XmlElementFactory.GetInstance</code> method to get an instance of the element factory, passing in an existing <code class="code highlight language-text">ITreeNode</code> for context.</p>

<p>The <code class="code highlight language-text">IXmlElementFactory</code> interface provides more fine-grained methods for creating XML tree nodes (note that <code class="code highlight language-text">XmlElementFactory</code> <strong>does not</strong> implement <code class="code highlight language-text">IXmlElementFactory</code>). This interface is implemented per-language, for each XML-derived language (such as web.config, build scripts, etc). The default implementation is <code class="code highlight language-text">XmlTreeNodeFactory</code>. The <code class="code highlight language-text">XmlTreeNodeFactory.GetInstance</code> static methods will get the appropriate language specific implementation.</p>

<aside class="note">
  <p> There is also the <code class="code highlight language-text">XmlElementFactory&lt;TXmlLanguage&gt;</code> class, which derives from <code class="code highlight language-text">XmlElementFactory</code>, and also provides a <code class="code highlight language-text">GetInstance</code> method. This method allows for creating an instance of <code class="code highlight language-text">XmlElementFactory</code> without using an existing <code class="code highlight language-text">ITreeNode</code> to provide the context for which XML-derived language is being used (e.g. web.config, .resx, etc). There are also the <code class="code highlight language-text">ResxElementFactory</code> and <code class="code highlight language-text">XamlElementFactory</code> which derive from <code class="code highlight language-text">XmlElementFactory&lt;TXmlLanguage&gt;</code> and provide extra functionality for <code class="code highlight language-text">.resx</code> and XAML files.</p>
</aside>

<p>See the documentation on <a href="ElementFactories.html"><span>element factories</span></a> for more details.</p>

<a name="modifying-nodes" class="elem-anchor"></a>
<h2>Modifying nodes<a href="#modifying-nodes" class="anchor-link"><span></span></a></h2>

<p>Unless a tree node or utility class provides a helper method for manipulating the tree node, then any time the content of the XML tree needs to be updated, then the node containing that content must be replaced. That is, a new node is created, and replaces the old node in the tree.</p>

<p>This can be quite complex, depending on what exactly needs to be replaced. The <code class="code highlight language-text">XmlElementFactory</code> class provides methods to easily create tags and attributes, but not for creating other node types. The language specific implementations of <code class="code highlight language-text">IXmlElementFactory</code> can create all of the other node types, but usually requires more work to build the tree nodes required.</p>

<p>For example, replacing the inner text of a tag is complicated by the text being represented by both text token nodes and whitespace token nodes. Replacing a single word is therefore straightforward:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">void</span> <span class="nf">ReplaceTextNode</span><span class="p">(</span><span class="n">IXmlTag</span> <span class="n">tag</span><span class="p">,</span> <span class="n">IXmlFloatingTextTokenNode</span> <span class="n">oldToken</span><span class="p">,</span> <span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Will only take the write lock if tag is part of a &quot;real&quot; tree</span>
  <span class="n">using</span><span class="p">(</span><span class="n">WriteLockCookie</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tag</span><span class="p">.</span><span class="n">IsPhysical</span><span class="p">()))</span>
  <span class="p">{</span>
    <span class="n">IXmlElementFactory</span> <span class="n">elementFactory</span> <span class="p">=</span> <span class="n">XmlTreeNodeFactory</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>

    <span class="c1">// We&#39;re not doing enough parsing to make it useful to intern strings more efficiently</span>
    <span class="kt">var</span> <span class="n">tokenIntern</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LexerTokenIntern</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">tokenNodeType</span> <span class="p">=</span> <span class="n">tag</span><span class="p">.</span><span class="n">XmlTokenTypes</span><span class="p">.</span><span class="n">TEXT</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">newToken</span> <span class="p">=</span> <span class="n">elementFactory</span><span class="p">.</span><span class="n">CreateToken</span><span class="p">(</span><span class="n">tokenIntern</span><span class="p">,</span> <span class="n">tokenNodeType</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="n">ModificationUtil</span><span class="p">.</span><span class="n">ReplaceChild</span><span class="p">(</span><span class="n">oldToken</span><span class="p">,</span> <span class="n">newToken</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>However, replacing content that spans whitespace nodes is more involved. A better approach here can be to create a new tag with the entire expected text content, and replace the child nodes of the original tag with the new tag’s children. Alternatively, replace the whole tag with the newly created one (ensuring attributes are correctly copied across).</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">void</span> <span class="nf">ReplaceTextContents</span><span class="p">(</span><span class="n">IXmlTag</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">using</span><span class="p">(</span><span class="n">WriteLockCookie</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">tag</span><span class="p">.</span><span class="n">IsPhysical</span><span class="p">()))</span>
  <span class="p">{</span>
    <span class="c1">// Get an instance of XmlElementFactory, NOT IXmlElementFactory</span>
    <span class="n">XmlElementFactory</span> <span class="n">elementFactory</span> <span class="p">=</span> <span class="n">XmlElementFactory</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>

    <span class="c1">// Create the text to be used to create the tag</span>
    <span class="kt">var</span> <span class="n">tagText</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;&lt;foo&gt;{0}&lt;/foo&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">newTag</span> <span class="p">=</span> <span class="n">elementFactory</span><span class="p">.</span><span class="n">CreateRootTag</span><span class="p">(</span><span class="n">tagText</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">oldTextTokens</span> <span class="p">=</span> <span class="n">tag</span><span class="p">.</span><span class="n">InnerTextTokens</span><span class="p">;</span>
    <span class="n">ModificationUtil</span><span class="p">.</span><span class="n">DeleteChildRange</span><span class="p">(</span><span class="n">oldTextTokens</span><span class="p">.</span><span class="n">First</span><span class="p">(),</span> <span class="n">oldTextTokens</span><span class="p">.</span><span class="n">Last</span><span class="p">());</span>

    <span class="kt">var</span> <span class="n">newTextTokens</span> <span class="p">=</span> <span class="n">newTag</span><span class="p">.</span><span class="n">InnerTextTokens</span><span class="p">;</span>
    <span class="n">ModificationUtil</span><span class="p">.</span><span class="n">AddChildRangeAfter</span><span class="p">(</span><span class="n">tag</span><span class="p">.</span><span class="n">Header</span><span class="p">,</span> <span class="n">newTextTokens</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>



                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper/devguide/app/js/main.build" data-baseurl="/resharper/devguide/" src="/resharper/devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

