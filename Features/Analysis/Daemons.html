


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper/devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper/devguide/styles/styles.css"></head>
<body data-id="Features/Analysis/Daemons">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="daemons" class="elem-anchor"></a>
<h1>Daemons<a href="#daemons" class="anchor-link"><span></span></a></h1>

<p>As you may have noticed, ReSharper features background analysis of your code. In fact, at any one time there are several different analyzers running at different <em>stages</em>, all combining to provide the most complete assessment of your code.</p>

<a name="daemon-stage" class="elem-anchor"></a>
<h2>Daemon Stage<a href="#daemon-stage" class="anchor-link"><span></span></a></h2>

<p>When writing a plugin, you will most likely be implementing your own daemon stage - a class decorated with the <code class="code highlight language-text">DaemonStage</code> attribute that implements the <code class="code highlight language-text">IDaemonStage</code> interface.</p>

<p>The interface is fairly simple, and has two members:</p>

<ul>
  <li>The <code class="code highlight language-text">CreateProcess()</code> method is where one or more daemon stage processes are created. A daemon stage process is created on a per-document basis to analyze files and provide information about them. Note that <code class="code highlight language-text">IDaemonStageProcess</code> can yield several different processes that can correspond to different injected PSI documents.</li>
  <li>The <code class="code highlight language-text">NeedsErrorStripe()</code> method is used to determine whether or not analysese from this daemon stage contribute to the markers on the right-hand stripe, as well as to the list of document errors. There are only three possible values from the <code class="code highlight language-text">ErrorStripeRequest</code> enumeration that can be returned here.</li>
</ul>

<p>ReSharper also comes with concrete base classes that implement <code class="code highlight language-text">IDaemonStage</code> (e.g., <code class="code highlight language-text">CSharpDaemonStageBase</code>) - these reduce the <code class="code highlight language-text">CreateProcess()</code> method to creating a single <code class="code highlight language-text">IDaemonStageProcess</code> corresponding to a single PSI file.</p>

<a name="daemon-stage-process" class="elem-anchor"></a>
<h2>Daemon Stage Process<a href="#daemon-stage-process" class="anchor-link"><span></span></a></h2>

<p>The daemon stage process also happens to be a class that implements the <code class="code highlight language-text">IDaemonStageProcess</code> interface. Typically, this class is passed the daemon stage so that it can get, e.g., the solution or current file from that variable.</p>

<p>The <code class="code highlight language-text">IDaemonStageProcess</code> interface has two members:</p>

<ul>
  <li>A property called <code class="code highlight language-text">DaemonProcess</code> which returns the corresponding daemon process. Typically you would return the value that you passed into the constructor.</li>
  <li>A method called <code class="code highlight language-text">Execute()</code> where the actual analysis happens.</li>
</ul>

<p>Let’s talk about the Execute method in more detail. If you’ve inherited from a class such as <code class="code highlight language-text">CSharpDaemonStageBase</code>, your <code class="code highlight language-text">CreateProcess()</code> override already has a parameter of type <code class="code highlight language-text">ICSharpFile</code> that you can use. If not, you can use an extension method in <code class="code highlight language-text">PsiManagerExtensions</code> to acquire the file:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="kt">var</span> <span class="n">file</span> <span class="p">=</span> <span class="n">process</span><span class="p">.</span><span class="n">SourceFile</span><span class="p">.</span><span class="n">GetPsiFiles</span><span class="p">&lt;</span><span class="n">CSharpLanguage</span><span class="p">&gt;();</span></code></pre>

<p>Now that you have the code structure you want to analyse, you spin up one of the element processors on it. An element processor is a class implementing an interface such as <code class="code highlight language-text">IRecursiveElementProcessor</code>, that lets you walk around all the tree nodes in a particular block of code. In the case of a recursive element processor, it has the following methods:</p>

<ul>
  <li><code class="code highlight language-text">InteriorShouldBeProcessed()</code> determines whether the interior of the provided ITreeNode should be processed. If it returns true, the processor will drill down into the inner structures. If it returns false, the processor will stop at this level.</li>
  <li><code class="code highlight language-text">ProcessBeforeInterior()</code> lets you process the tree node before you’ve gone into its descendants.</li>
  <li><code class="code highlight language-text">ProcessAfterInterior()</code> lets you process the tree node after you’ve gone through its descendants.</li>
</ul>

<a name="highlighting" class="elem-anchor"></a>
<h2>Highlighting<a href="#highlighting" class="anchor-link"><span></span></a></h2>

<p>Now, the end result of all the work done by the recursive element processor is a set of <em>highlighting</em>. A highlighting is essentially information about a piece of code that has to be highlighted (underlined with a wavy line), as well as shown in the marker bar and possibly in the document errors. Highlightings also happen to be the points on which Quick-Fixes work.</p>

<p>Highlightings all implement the <code class="code highlight language-text">IHighlighting</code> interface and are decorated with one of the highlighting attributes related to the type of highlighting it is. There are two types of highlightings available:</p>

<ul>
  <li>The <code class="code highlight language-text">StaticSeverityHighlighting</code> attribute is used to indicate a highlighting that never goes away. This means that when you set it, it <em>will</em> be shown.</li>
  <li>The <code class="code highlight language-text">ConfigurableSeverityHighlighting</code> lets the user configure if and when this highlighting is shown. As a consequence, it has context actions to let you disable it temporarily or edit its settings.</li>
</ul>

<p>There are several pieces of information that your own highlighting class can provide. At a minimum, you can specify:</p>

<ul>
  <li>The severity of the highlighting. This is defined in the severity attribute.</li>
  <li>The tooltip for the highlighting when you move the caret over it in the editor.</li>
  <li>The tooltip for the marker bar.</li>
</ul>

<p>So - coming back to the daemon stage process - you have invoked the element processor (or several) and got a set of highlightings. The last thing to do is to commit the results using the commiter that is provided as a parameter to the <code class="code highlight language-text">Execute()</code> method:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="n">commiter</span><span class="p">(</span><span class="k">new</span> <span class="n">DaemonStageResult</span><span class="p">(</span><span class="n">elementProcessor</span><span class="p">.</span><span class="n">Highlightings</span><span class="p">));</span></code></pre>

<p>And that’s it - your daemon is ready to go!</p>

<a name="elementproblemanalyzer" class="elem-anchor"></a>
<h2>ElementProblemAnalyzer<a href="#elementproblemanalyzer" class="anchor-link"><span></span></a></h2>

<p>If you are looking for a simpler way to perform an analysis and add highlightings to code, the <code class="code highlight language-text">ElementProblemAnalyzer&lt;T&gt;</code> class presents an alternative. If you use this class, you only have to have one single type instead of defining both a daemon and a daemon stage.</p>

<p>Put briefly, the element problem analyzer is a class that:</p>

<ul>
  <li>Inherits from <code class="code highlight language-text">ElementProblemAnalyzer&lt;T&gt;</code> where <code class="code highlight language-text">T</code> is a type inheriting from <code class="code highlight language-text">ITreeNode</code> (e.g., an <code class="code highlight language-text">IExpression</code>) that will subsequently be subject to analysis throughout the file.</li>
  <li>Is decorated by the <code class="code highlight language-text">[ElementProblemAnalyzer]</code> attribute. This attribute takes parameters which indicate the elements the analyzer highlights as well as the highlighting types it uses.</li>
  <li>Implements a single method called <code class="code highlight language-text">Run()</code> where analysis and highlighting happens.</li>
</ul>

<p>The <code class="code highlight language-text">Run()</code> method is invoked recursively for every element of type <code class="code highlight language-text">T</code> found in the file. For example, if <code class="code highlight language-text">T == IExpression</code>, the <code class="code highlight language-text">Run()</code> method will be called for every expression that is found. The method signature is as follows:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">T</span> <span class="n">element</span><span class="p">,</span> <span class="n">ElementProblemAnalyzerData</span> <span class="n">data</span><span class="p">,</span> <span class="n">IHighlightingConsumer</span> <span class="n">consumer</span><span class="p">)</span></code></pre>

<p>The parameters are:</p>

<ul>
  <li><code class="code highlight language-text">T element</code> - the element currently being analyzed. Its type is defined when inheriting the class.</li>
  <li><code class="code highlight language-text">ElementProblemAnalyzerData data</code> - contains references to certain useful parts of the ecosystem, such as the controlling <code class="code highlight language-text">IDaemonProcess</code> and the settings store.</li>
  <li><code class="code highlight language-text">IHighlightingConsumer</code> - this interface is used to add the highlightings to various elements.</li>
</ul>

<p>The following is an example implementation of an element problem analyzer:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[ElementProblemAnalyzer(new[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IExpression</span><span class="p">)</span> <span class="p">},</span> 
  <span class="n">HighlightingTypes</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">UseOfInt64MaxValueLiteralHighlighting</span><span class="p">)</span> <span class="p">})]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">UseOfInt64MaxValueLiteralChecker</span> <span class="p">:</span> <span class="n">ElementProblemAnalyzer</span><span class="p">&lt;</span><span class="n">IExpression</span><span class="p">&gt;</span>
<span class="p">{</span>
  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">IExpression</span> <span class="n">element</span><span class="p">,</span> <span class="n">ElementProblemAnalyzerData</span> <span class="n">data</span><span class="p">,</span> <span class="n">IHighlightingConsumer</span> <span class="n">consumer</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">element</span><span class="p">.</span><span class="n">ConstantValue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">value</span><span class="p">.</span><span class="n">IsLong</span><span class="p">())</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="kt">long</span> <span class="n">number</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToInt64</span><span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="p">!=</span> <span class="n">Int64</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="n">consumer</span><span class="p">.</span><span class="n">AddHighlighting</span><span class="p">(</span><span class="k">new</span> <span class="n">UseOfInt64MaxValueLiteralHighlighting</span><span class="p">(</span><span class="n">element</span><span class="p">),</span> 
      <span class="n">element</span><span class="p">.</span><span class="n">GetDocumentRange</span><span class="p">(),</span> <span class="n">element</span><span class="p">.</span><span class="n">GetContainingFile</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>



                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper/devguide/app/js/main.build" data-baseurl="/resharper/devguide/" src="/resharper/devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

