


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper-devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper-devguide/styles/styles.css"></head>
<body data-id="Features/Analysis/Testing">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="testing-daemon-stages-and-highlights" class="elem-anchor"></a>
<h1>Testing Daemon Stages and Highlights<a href="#testing-daemon-stages-and-highlights" class="anchor-link"><span></span></a></h1>

<p>The <code class="code highlight language-text">HighlightingTestBase</code> base class provides infrastructure for testing daemons, element problem analysers and highlightings. It creates an in-memory project, adds a file and analyses it. The resulting highlights are then written to a <code class="code highlight language-text">.tmp</code> file and compared against the <code class="code highlight language-text">.gold</code> file. If the files differ, the test fails.</p>

<p>Further derived classes, such as <code class="code highlight language-text">CssHighlightingTestBase</code>, <code class="code highlight language-text">CSharpHighlightingTestBase</code>, <code class="code highlight language-text">CSharpHighlightingTestNet45Base</code>, etc. provide extra support for language specific tests.</p>

<ul id="markdown-toc">
  <li><a href="#input-and-gold-files" id="markdown-toc-input-and-gold-files"><span>Input and gold files<a href="#input-and-gold-files" class="anchor-link"><span></span></a></span></a></li>
  <li><a href="#using-the-base-class" id="markdown-toc-using-the-base-class"><span>Using the base class<a href="#using-the-base-class" class="anchor-link"><span></span></a></span></a>    <ul>
      <li><a href="#testing-with-combinations-of-settings" id="markdown-toc-testing-with-combinations-of-settings"><span>Testing with combinations of settings<a href="#testing-with-combinations-of-settings" class="anchor-link"><span></span></a></span></a></li>
      <li><a href="#filtering-highlights" id="markdown-toc-filtering-highlights"><span>Filtering highlights<a href="#filtering-highlights" class="anchor-link"><span></span></a></span></a></li>
      <li><a href="#customising-the-base-class" id="markdown-toc-customising-the-base-class"><span>Customising the base class<a href="#customising-the-base-class" class="anchor-link"><span></span></a></span></a></li>
    </ul>
  </li>
  <li><a href="#derived-classes" id="markdown-toc-derived-classes"><span>Derived classes<a href="#derived-classes" class="anchor-link"><span></span></a></span></a></li>
  <li><a href="#testing-gutter-marks-and-dead-code" id="markdown-toc-testing-gutter-marks-and-dead-code"><span>Testing gutter marks and dead code<a href="#testing-gutter-marks-and-dead-code" class="anchor-link"><span></span></a></span></a></li>
</ul>

<a name="input-and-gold-files" class="elem-anchor"></a>
<h2>Input and gold files<a href="#input-and-gold-files" class="anchor-link"><span></span></a></h2>

<p>The input file is a simple text file. The location of the text caret is irrelevant to highlight tests, so placeholders are not required. As an example testing C# local variable usage:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">class</span> <span class="nc">C</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">void</span> <span class="nf">foo</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">cond</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">counter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
      <span class="n">counter</span><span class="p">++;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>By default, the gold file will look something like this:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_text">class C
{
  public void foo (bool cond)
  {
    |int|(0) |counter|(1) = 0;
    while(|cond|(2))
      counter++;
  }
}
---------------------------------------------------------
(0): ReSharper Hint: Use implicitly typed local variable declaration
(1): ReSharper Warning [CS0219]: Local variable &#39;counter&#39; is only assigned but its value is never used
(2): ReSharper Warning: Loop control variable is never changed inside loop</code></pre>

<p>The input file is replicated at the top of the gold file, with the location of highlights marked up using the <code class="code highlight language-text">|text|(index)</code> format. The text that the highlight is applied to is delimited with pipe characters <code class="code highlight language-text">|</code>, with the index of the highlight listed after, in brackets.</p>

<p>The text of the highlight, which would normally be displayed as a tooltip or in the status bar, is added to the end of the file, after a separator. Each highlight’s index is listed first.</p>

<p>It is possible to change the output of the highlight text by overriding the <code class="code highlight language-text">CreateHighlightingDumper</code> method and returning a custom instance of <code class="code highlight language-text">TestHighlightingDumper</code>.</p>

<a name="using-the-base-class" class="elem-anchor"></a>
<h2>Using the base class<a href="#using-the-base-class" class="anchor-link"><span></span></a></h2>

<p>In order to use the base class, simply derive from <code class="code highlight language-text">HighlightingTestBase</code>, or one of the more language specific derived class (see below for more details on these derived classes), and call <code class="code highlight language-text">DoTestSolution</code>, <code class="code highlight language-text">DoNamedTest</code> or <code class="code highlight language-text">DoNamedTest2</code> in the test method. As ever, the <code class="code highlight language-text">RelativeTestDataPath</code> should be overridden to describe where the test data files are located. Most of the language specific base classes set up a value of <code class="code highlight language-text">Daemon\&lt;Langauge&gt;</code>.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">DoTest</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Runs a specific set of files</span>
  <span class="n">DoTestSolution</span><span class="p">(</span><span class="s">&quot;Foo.cs&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">CheckHighlights</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// File name is based on the name of the test,</span>
  <span class="c1">// e.g. &quot;CheckHighlights.cs&quot;</span>
  <span class="n">DoNamedTest</span><span class="p">();</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">TestLocalVariableUsage</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// File name is based on the name of the test, stripping a &quot;Test&quot; prefix</span>
  <span class="c1">// e.g. &quot;LocalVariableUsage.cs&quot;</span>
  <span class="n">DoNamedTest2</span><span class="p">();</span>
<span class="p">}</span></code></pre>

<p>The <code class="code highlight language-text">DoNamedTest</code> and <code class="code highlight language-text">DoNamedTest2</code> methods automatically add an extension in order to find the input file. This extension comes from the <code class="code highlight language-text">Extension</code> property, which looks for attributes on the test method or class that implement <code class="code highlight language-text">ITestFileExtensionProvider</code>, such as <code class="code highlight language-text">TestFileExtensionAttribute</code>. It defaults to <code class="code highlight language-text">.cs</code>.</p>

<p>Additional files can be passed to either <code class="code highlight language-text">DoTestSolution</code> and <code class="code highlight language-text">DoNamedTest</code>/<code class="code highlight language-text">DoNamedTest2</code>. This allows for testing a single file while also allowing other files to produce a compilable project.</p>

<a name="testing-with-combinations-of-settings" class="elem-anchor"></a>
<h3>Testing with combinations of settings<a href="#testing-with-combinations-of-settings" class="anchor-link"><span></span></a></h3>

<p>The <code class="code highlight language-text">HighlightinTestBase</code> class understands iterating over multiple combinations of settings. In order to make use of this, please refer to the section on <a href="../../Plugin/Testing/OptionsIterator.html"><span>settings iteration</span></a>.</p>

<a name="filtering-highlights" class="elem-anchor"></a>
<h3>Filtering highlights<a href="#filtering-highlights" class="anchor-link"><span></span></a></h3>

<p>The test class can filter what highlights it wished to test, by overriding the <code class="code highlight language-text">HighlightingPredicate</code> method.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">protected</span> <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">HighlightingPredicate</span><span class="p">(</span><span class="n">IHighlighting</span> <span class="n">highlighting</span><span class="p">,</span> <span class="n">IContextBoundSettingsStore</span> <span class="n">settingsStore</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">manager</span> <span class="p">=</span> <span class="n">HighlightingSettingsManager</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
  <span class="kt">var</span> <span class="n">severity</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">GetSeverity</span><span class="p">(</span><span class="n">highlighting</span><span class="p">,</span> <span class="n">settingsStore</span><span class="p">);</span>
  <span class="kt">var</span> <span class="n">attribute</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">GetHighlightingAttribute</span><span class="p">(</span><span class="n">highlighting</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">severity</span> <span class="p">==</span> <span class="n">Severity</span><span class="p">.</span><span class="n">INFO</span> <span class="p">&amp;&amp;</span> <span class="n">attribute</span><span class="p">.</span><span class="n">OverlapResolve</span> <span class="p">==</span> <span class="n">OverlapResolveKind</span><span class="p">.</span><span class="n">NONE</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

  <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span></code></pre>

<p>The default implementation, as shown above, looks up the configured severity of the highlight, and hides it if it’s set to <code class="code highlight language-text">Severity.INFO</code> and its overlap resolution is set to <code class="code highlight language-text">OverlapResolveKind.NONE</code>. This combination is usually used by static highlights, identifier highlights, gutter marks and context highlighting, which are not usually useful in a highlighter test. However, if the test needs to see this kind of highlighting, simply override the <code class="code highlight language-text">HighlightingPredicate</code> method to suit.</p>

<a name="customising-the-base-class" class="elem-anchor"></a>
<h3>Customising the base class<a href="#customising-the-base-class" class="anchor-link"><span></span></a></h3>

<p>The following properties and methods can be overridden to alter the behaviour of the tests:</p>

<ul>
  <li><code class="code highlight language-text">WithProject</code> is called once the project is created and just before the main test code is run. This is a useful hook for project specific setup, such as setting C# language level, or custom tools on added files.</li>
  <li><code class="code highlight language-text">ColorIdentifiers</code> - override this property to enable ReSharper’s “Color identifiers” option, which will highlight different types of identifiers with different colours, e.g. classes get one colour, interfaces get another. This is set to <code class="code highlight language-text">false</code> by default.</li>
  <li><code class="code highlight language-text">ProjectOutputType</code> can be overridden if the output type of the project (console, assembly, etc.) is relevant to the tests.</li>
  <li><code class="code highlight language-text">GetReferencedAssemblies</code> is used to add extra references to the created project. The default implementation will look for any attributes on the test class that implement <code class="code highlight language-text">ITestLibraryReferencesProvider</code>, such as <code class="code highlight language-text">TestReferencesAttribute</code>, or derived classes like <code class="code highlight language-text">TestNetCore45Attribute</code>, and add any references, expanding environment variables.</li>
  <li><code class="code highlight language-text">GetSdkReferences</code> will add SDK references, by default looking for attributes that implement <code class="code highlight language-text">ITestSdkReferencesProvider</code>, such as <code class="code highlight language-text">TestSdksAttribute</code> or <code class="code highlight language-text">TestWinJSApplicationAttribute</code>.</li>
  <li><code class="code highlight language-text">ProcessAllFiles</code> can be overridden in order to process all files in the project. By default, only one file is expected, and only the first found is run.</li>
  <li><code class="code highlight language-text">CreateHighlightingDumper</code> can be overridden to provide an instance of <code class="code highlight language-text">TestHighlightingDumper</code> that outputs the highlights in a different format. A typical use of this is to replace the default implementation with an instance of <code class="code highlight language-text">TestHighlightingDumperWithType</code>, which simply adds the type name of the highlight to the output.</li>
</ul>

<a name="derived-classes" class="elem-anchor"></a>
<h2>Derived classes<a href="#derived-classes" class="anchor-link"><span></span></a></h2>

<p>The following derived classes provide language specific features, such as adding appropriate assembly references and setting up the default file extension:</p>

<ul>
  <li><strong><code class="code highlight language-text">CSharpHighlightingTestBase</code></strong> provides overrides for <code class="code highlight language-text">DoNamedTest</code> and <code class="code highlight language-text">DoNamedTest2</code> that allow specifying a C# language level. The <code class="code highlight language-text">CSharpHighlightTestNet45Base</code>, <code class="code highlight language-text">CSharpHighlightingTestNet4Base</code> and <code class="code highlight language-text">WinRTHighlightingTestBase</code> derived classes set up .net 4.5, .net 4 and WinRT tests, respectively.</li>
  <li><strong><code class="code highlight language-text">CssHighlightingTestBase</code></strong> provides an override of <code class="code highlight language-text">DoNamedTest</code> that takes a CSS language level.</li>
  <li><strong><code class="code highlight language-text">HtmlHighlightingTestBase</code></strong> is a base class for testing highlights in HTML and HTML-like languages.
    <ul>
      <li><strong><code class="code highlight language-text">AspHighlightingTestBase</code></strong> provides a base class for testing highlights in <code class="code highlight language-text">.aspx</code> files. It offers a couple of extra methods, including <code class="code highlight language-text">DoTestWithConfig</code> and <code class="code highlight language-text">DoTestFileWithControl</code>.</li>
    </ul>
  </li>
  <li><strong><code class="code highlight language-text">JavaScriptHighlightingTestBase</code></strong> - base class for JavaScript highlight tests. Sets up some default settings.</li>
  <li><strong><code class="code highlight language-text">TodoHighlightingTestBase</code></strong> provides a custom dumper to format todo items.</li>
  <li><strong><code class="code highlight language-text">TypeScriptHighlightingTestBase</code></strong> - base class for TypeScript highlights.</li>
  <li><strong><code class="code highlight language-text">VBHighlightingTestBase</code></strong> sets up the test for VB tests. Allows setting the language level before running a test:
  <code class="code highlight language-text">csharp
  [Test]
  public void Test01()
  {
    using (new LanguageLevelCookie(this, VBLanguageLevel.Vb10))
      DoNamedTest();
  }</code></li>
  <li><strong><code class="code highlight language-text">XamlHighlightingTestBase</code></strong> - abstract base class for XAML tests.</li>
</ul>

<a name="testing-gutter-marks-and-dead-code" class="elem-anchor"></a>
<h2>Testing gutter marks and dead code<a href="#testing-gutter-marks-and-dead-code" class="anchor-link"><span></span></a></h2>

<p>Gutter marks are essentially the same as normal highlights - the icons are displayed in the gutter of the text editor, but the highlight is still applied to a section of code such as a method declaration. Similarly, the highlight has text, and the text and location is listed in the gold file in exactly the same way as normal (underlined) highlights.</p>

<p>In order to make the tests a little easier, the test class can override the <code class="code highlight language-text">HighlightPredicate</code> method and filter the <code class="code highlight language-text">IHighlighting</code> instance to ensure it is of a known type for the gutter marks under test, e.g.:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">protected</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">HighlightingPredicate</span><span class="p">(</span><span class="n">IHighlighting</span> <span class="n">highlighting</span><span class="p">,</span> <span class="n">IContextBoundSettingsStore</span> <span class="n">settingsStore</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">highlighting</span> <span class="k">is</span> <span class="n">InheritanceMarkOnGutter</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span><span class="n">highlighting</span> <span class="k">is</span> <span class="n">RecursionMarkOnGutter</span><span class="p">);</span>
<span class="p">}</span></code></pre>

<p>Similarly, dead code is also just a highlight, and the tests are exactly the same.</p>


                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper-devguide/app/js/main.build" data-baseurl="/resharper-devguide/" src="/resharper-devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

