


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper/devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper/devguide/styles/styles.css"></head>
<body data-id="Features/Actions/Bulk">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="bulk-actions" class="elem-anchor"></a>
<h1>Bulk Actions<a href="#bulk-actions" class="anchor-link"><span></span></a></h1>

<aside class="warning">
  <p> This topic relates to ReSharper 8, and has not been updated to ReSharper 9 or the ReSharper Platform.</p>
</aside>

<p>A Bulk Action is a Quick-Fix or a Context Action that can be applied to an element in the syntax tree, a single file, or all files in a folder, project or solution. This <a href="http://www.jetbrains.com/resharper/webhelp/Code_Analysis__Fix_in_Scope.html" data-bypass="yes"><span>fix in scope</span></a> mechanism is displayed as a menu item on the <code class="code highlight language-text">Alt+Enter</code> menu that can be selected to affect the single item, or expanded to show the per-file, folder, project or solution scope:</p>

<p><img src="fix_in_scope.png" alt="Alt+Enter menu showing fix in scope context action" /></p>

<p>This mechanic is available for both quick-fix actions as well as context actions that are part of Code Cleanup.</p>

<p>In the case of a context action (such as ReSharper’s <code class="code highlight language-text">VarToTypeAction</code>, which converts the C# <code class="code highlight language-text">var</code> keyword to an explicit type), the implementation of additional items happens in the <code class="code highlight language-text">CreateBulbItems()</code> method. A context action can, of course, create all the required bulb items directly, but it can also use elements from the <code class="code highlight language-text">JetBrains.ReSharper.Intentions.Bulk</code> namespace to simplify the process.</p>

<p>In the case of <code class="code highlight language-text">VarToTypeAction</code>, ReSharper uses the <code class="code highlight language-text">BulkCodeCleanupContextActionBuilder</code> class to construct all the items as follows:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="kt">var</span> <span class="n">cleanupProfile</span> <span class="p">=</span> <span class="n">BulkCodeCleanupActionBuilderBase</span><span class="p">.</span><span class="n">CreateProfile</span><span class="p">(</span><span class="n">profile</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="n">profile</span><span class="p">.</span><span class="n">SetSetting</span><span class="p">(</span><span class="n">ReplaceByVar</span><span class="p">.</span><span class="n">USE_VAR_DESCRIPTOR</span>
  <span class="p">},</span> <span class="k">new</span> <span class="n">ReplaceByVar</span><span class="p">.</span><span class="n">Options</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">BehavourStyle</span> <span class="p">=</span> <span class="n">ReplaceByVar</span><span class="p">.</span><span class="n">BehavourStyle</span><span class="p">.</span><span class="n">CAN_CHANGE_TO_EXPLICIT</span><span class="p">,</span>
    <span class="n">ForeachVariableStyle</span> <span class="p">=</span> <span class="n">ReplaceByVar</span><span class="p">.</span><span class="n">ForeachVariableStyle</span><span class="p">.</span><span class="n">ALWAYS_EXPLICIT</span><span class="p">,</span>
    <span class="n">LocalVariableStyle</span> <span class="p">=</span> <span class="n">ReplaceByVar</span><span class="p">.</span><span class="n">LocalVariableStyle</span><span class="p">.</span><span class="n">ALWAYS_EXPLICIT</span>
  <span class="p">}));</span>

<span class="kt">var</span> <span class="n">projectFile</span> <span class="p">=</span> <span class="n">myProvider</span><span class="p">.</span><span class="n">SourceFile</span><span class="p">.</span><span class="n">ToProjectFile</span><span class="p">();</span>
<span class="n">Assertion</span><span class="p">.</span><span class="n">AssertNotNull</span><span class="p">(</span><span class="n">projectFile</span><span class="p">,</span> <span class="s">&quot;projectFile must not be null&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">BulkCodeCleanupContextActionBuilder</span><span class="p">.</span><span class="n">CreateByPsiLanguage</span><span class="p">&lt;</span><span class="n">CSharpLanguage</span><span class="p">&gt;(</span><span class="n">cleanupProfile</span><span class="p">,</span>
  <span class="s">&quot;Use explicit type everywhere&quot;</span><span class="p">,</span> <span class="n">projectFile</span><span class="p">.</span><span class="n">GetSolution</span><span class="p">(),</span> <span class="k">this</span><span class="p">);</span>
<span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">CreateBulkActions</span><span class="p">(</span><span class="n">projectFile</span><span class="p">,</span> <span class="n">IntentionsAnchors</span><span class="p">.</span><span class="n">ContextActionsAnchor</span><span class="p">,</span>
  <span class="n">IntentionsAnchors</span><span class="p">.</span><span class="n">ContextActionsAnchorPosition</span><span class="p">);</span></code></pre>

<p>The exact mechanic of creating bulk context actions can be found in <code class="code highlight language-text">BulkIntentionsBuilderEx.CreateBulkActions()</code>. It is a rather simple process that creates actions for the current caret position, then (if applicable) the current file, project folder, project or the whole solution.</p>

<p>Quick-fixes have a similar workflow - create a builder and in your call <code class="code highlight language-text">CreateBulbItems</code> method, return <code class="code highlight language-text">builder.CreateBulkActions()</code>. The builder to use for quick-fixes is called <code class="code highlight language-text">BulkQuickFixWithCommonTransactionBuilder</code>, and can be used in a couple of ways. As of ReSharper 8.2, it is internally used for quick-fixes such as <code class="code highlight language-text">OptimizeImportsFix</code>, which removes all redundant C# “using” statements in a file, and optionally, folder, project and solution. In other words, the default implementation of the quick fix operates on the whole file, rather than the current text caret position.</p>

<p>As such, it has a slightly awkward API, and requires a little extra work to support an action at the caret position as well as file, folder, project and solution scope. The constructor has two overloads. The first takes in a <code class="code highlight language-text">QuickFixBase</code> that represents the “in file” scope, as well as a delegate to operate on files in folder, project and solution scope, and a predicate to see which file in scope it should apply to (e.g. just C# files). The second overload takes two <code class="code highlight language-text">QuickFixBase</code> instances. One is for the caret position, and the second is for the “in file” scope. It also requires the delegate and predicate.</p>

<p>The awkward part of this is that to support both “at caret” and “in file” scope, you need to implement two classes that derive from <code class="code highlight language-text">QuickFixBase</code>. Fortunately, this is mostly boilerplate and can be implemented using the same delegate passed in for folder, project and solution scope. You need just one class that looks something like this:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">BulkQuickFixInFileWithCommonPsiTransaction</span> <span class="p">:</span> <span class="n">QuickFixBase</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IProjectFile</span> <span class="n">myProjectFile</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IDocument</span><span class="p">,</span> <span class="n">IPsiSourceFile</span><span class="p">,</span> <span class="n">IProgressIndicator</span><span class="p">&gt;</span> <span class="n">myPsiTransactionAction</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">BulkQuickFixInFileWithCommonPsiTransaction</span> <span class="p">(</span><span class="n">IProjectFile</span> <span class="n">projectFile</span><span class="p">,</span> <span class="kt">string</span> <span class="n">actionText</span><span class="p">,</span>
    <span class="n">Action</span><span class="p">&lt;</span><span class="n">IDocument</span><span class="p">,</span> <span class="n">IPsiSourceFile</span><span class="p">,</span> <span class="n">IProgressIndicator</span><span class="p">&gt;</span> <span class="n">psiTransactionAction</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">myProjectFile</span> <span class="p">=</span> <span class="n">projectFile</span><span class="p">;</span>
    <span class="n">myPsiTransactionAction</span> <span class="p">=</span> <span class="n">psiTransactionAction</span><span class="p">;</span>
    <span class="n">Text</span> <span class="p">=</span> <span class="n">actionText</span> <span class="p">+</span> <span class="s">&quot; in file&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">IsAvailable</span><span class="p">(</span><span class="n">IUserDataHolder</span> <span class="n">cache</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="n">Text</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="k">override</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ITextControl</span><span class="p">&gt;</span> <span class="n">ExecutePsiTransaction</span><span class="p">(</span><span class="n">ISolution</span> <span class="n">solution</span><span class="p">,</span> <span class="n">IProgressIndicator</span> <span class="n">progress</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">documentManager</span> <span class="p">=</span> <span class="n">solution</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">DocumentManager</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="n">documentManager</span><span class="p">.</span><span class="n">GetOrCreateDocument</span><span class="p">(</span><span class="n">myProjectFile</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">psiSourceFile</span> <span class="p">=</span> <span class="n">projectFile</span><span class="p">.</span><span class="n">ToSourceFile</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psiSourceFile</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="n">myPsiTransactionAction</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">psiSourceFile</span><span class="p">,</span> <span class="n">progress</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>So, if your quick-fix operates on just the caret position, you should do something like this:</p>

<ul>
  <li>Implement the quick-fix. The <code class="code highlight language-text">ExecutePsiTransaction()</code> method just fixes the issue at the text caret position</li>
  <li>
    <p>Prepare an action that processes a single file with your chosen logic. Here’s an example:</p>

    <p><code class="code highlight language-text">csharp
  var solution = projectFile.GetSolution();
  var psiFiles = solution.GetComponent&lt;IPsiFiles&gt;();
  Action&lt;IDocument, IPsiSourceFile, IProgressIndicator&gt; processFileAction =
    (document, psiSourceFile, indicator) =&gt;
  {
    var csharpFiles = psiFiles.GetPsiFiles&lt;CSharpLanguage&gt;(psiSourceFile).OfType&lt;ICSharpFile&gt;();
    foreach (var csharpFile in csharpFiles)
    {
      UsingUtil.RemoveUnusedImports(document, csharpFile);
    }
  };</code></p>
  </li>
  <li>
    <p>Create an instance of the <code class="code highlight language-text">BulkQuickFixInFileWithCommonPsiTransaction</code> class defined above (make sure to add this class to your project), passing in an instance of the <code class="code highlight language-text">processFileAction</code> delegate</p>

    <p><code class="code highlight language-text">csharp
  var inFileFix = new BulkQuickFixInFileWithCommonPsiTransaction(projectFile, RemoveUnusedDirectivesString, processFileAction);</code></p>
  </li>
  <li>
    <p>Create a <code class="code highlight language-text">BulkQuickFixWithCommonTransactionBuilder</code>, which also happens to accept a predicate that you can use to filter out files you do not want to process:</p>

    <p><code class="code highlight language-text">csharp
  var acceptProjectFilePredicate = BulkItentionsBuilderEx.CreateAcceptFilePredicateByPsiLanaguage&lt;CSharpLanguage&gt;(solution);
  var builder = new BulkQuickFixWithCommonTransactionBuilder(this, inFileFix, solution, RemoveUnusedDirectivesString, processFileAction, acceptProjectFilePredicate);</code></p>
  </li>
  <li>
    <p>Finally, use the builder to create all the actions in bulk:</p>

    <p><code class="code highlight language-text">csharp
  return builder.CreateBulkActions(projectFile, IntentionsAnchors.QuickFixesAnchor, IntentionsAnchors.QuickFixesAnchorPosition);</code></p>
  </li>
</ul>

<p>And if your quick-fix operates on the whole file by default, and doesn’t operate only at the issue at the caret position (e.g. remove all redundant using statements):</p>

<ul>
  <li>Implement the quick-fix. The <code class="code highlight language-text">ExecutePsiTransaction()</code> method fixes the issue across the whole file</li>
  <li>
    <p>Prepare an action that processes a single file with your chosen logic. The example here is the same as above:</p>

    <p><code class="code highlight language-text">csharp
  var solution = projectFile.GetSolution();
  var psiFiles = solution.GetComponent&lt;IPsiFiles&gt;();
  Action&lt;IDocument, IPsiSourceFile, IProgressIndicator&gt; processFileAction = (document, psiSourceFile, indicator) =&gt;
  {
    var csharpFiles = psiFiles.GetPsiFiles&lt;CSharpLanguage&gt;(psiSourceFile).OfType&lt;ICSharpFile&gt;();
    foreach (var csharpFile in csharpFiles)
    {
      UsingUtil.RemoveUnusedImports(document, csharpFile);
    }
  };</code></p>
  </li>
  <li>
    <p>Create a <code class="code highlight language-text">BulkQuickFixWithCommonTransactionBuilder</code>, together with a predicate to indicate which files you want to process. Note that we call a different constructor here, and pass in <code class="code highlight language-text">this</code> as the quick fix to operate by default. This overload treats this quick-fix as the “in file” scope quick fix, and assumes the “at caret position” quick-fix isn’t required:</p>

    <p><code class="code highlight language-text">csharp
  var acceptProjectFilePredicate = BulkItentionsBuilderEx.CreateAcceptFilePredicateByPsiLanaguage&lt;CSharpLanguage&gt;(solution);
  var builder = new BulkQuickFixWithCommonTransactionBuilder(this, solution, RemoveUnusedDirectivesString, processFileAction, acceptProjectFilePredicate);</code></p>
  </li>
  <li>Finally, use the builder to create all the actions in bulk:</li>
</ul>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">CreateBulkActions</span><span class="p">(</span><span class="n">projectFile</span><span class="p">,</span> <span class="n">IntentionsAnchors</span><span class="p">.</span><span class="n">QuickFixesAnchor</span><span class="p">,</span> <span class="n">IntentionsAnchors</span><span class="p">.</span><span class="n">QuickFixesAnchorPosition</span><span class="p">);</span></code></pre>



                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper/devguide/app/js/main.build" data-baseurl="/resharper/devguide/" src="/resharper/devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

