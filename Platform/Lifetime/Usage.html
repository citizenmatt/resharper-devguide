


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper/devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper/devguide/styles/styles.css"></head>
<body data-id="Platform/Lifetime/Usage">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="usage" class="elem-anchor"></a>
<h1>Usage<a href="#usage" class="anchor-link"><span></span></a></h1>

<p>The <code class="code highlight language-text">Lifetime</code> class looks like this:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Lifetime</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Lifetime</span> <span class="nf">AddAction</span><span class="p">(</span><span class="n">Action</span> <span class="n">f</span><span class="p">);</span>
  <span class="k">public</span> <span class="n">Lifetime</span> <span class="nf">AddBracket</span><span class="p">(</span><span class="n">Action</span> <span class="n">fOpening</span><span class="p">,</span> <span class="n">Action</span> <span class="n">fClosing</span><span class="p">);</span>
  <span class="k">public</span> <span class="n">Lifetime</span> <span class="nf">AddDispose</span><span class="p">(</span><span class="n">IDisposable</span> <span class="n">item</span><span class="p">);</span>
  <span class="k">public</span> <span class="n">Lifetime</span> <span class="nf">AddRef</span><span class="p">(</span><span class="kt">object</span> <span class="n">o</span><span class="p">);</span>
  <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsTerminated</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>Your code receives a <code class="code highlight language-text">Lifetime</code> instance, and registers its cleanup callback using <code class="code highlight language-text">AddAction</code>. It then doesn’t need to do anything else. When the <code class="code highlight language-text">Lifetime</code> is terminated, the callback is called, and the action is performed. Actions are called in reverse order to how they were added. If an exception is thrown by an action, it is logged, and the next action is called.</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">void</span> <span class="nf">MyMethod</span><span class="p">(</span><span class="n">Lifetime</span> <span class="n">lifetime</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lifetime</span><span class="p">.</span><span class="n">AddAction</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="cm">/* Do cleanup */</span> <span class="p">});</span>
<span class="p">}</span></code></pre>

<ul>
  <li>
    <p>The <code class="code highlight language-text">AddBracket</code> method accepts two callbacks. The first, <code class="code highlight language-text">fOpening</code>, is called immediately, and the second, <code class="code highlight language-text">fClosing</code> is registered to run when the <code class="code highlight language-text">Lifetime</code> is terminated. This way, the methods form a “bracket” around the duration of the <code class="code highlight language-text">Lifetime</code> object.</p>
  </li>
  <li>
    <p>There is also a bridge between <code class="code highlight language-text">IDisposable</code> and <code class="code highlight language-text">Lifetime</code>. The <code class="code highlight language-text">AddDispose</code> method simply registers a callback that will call <code class="code highlight language-text">Dispose</code> on the given <code class="code highlight language-text">IDisposable</code>.</p>
  </li>
  <li>
    <p>The <code class="code highlight language-text">AddRef</code> method keeps a given object alive (i.e. it won’t be garbage collected) until the <code class="code highlight language-text">Lifetime</code> is terminated.</p>
  </li>
  <li>
    <p>You can check to see if a <code class="code highlight language-text">Lifetime</code> has been terminated by calling the <code class="code highlight language-text">IsTerminated</code> property. Note that you can’t terminate a <code class="code highlight language-text">Lifetime</code> directly.</p>
  </li>
</ul>

<a name="extension-methods" class="elem-anchor"></a>
<h2>Extension methods<a href="#extension-methods" class="anchor-link"><span></span></a></h2>

<p>Generally speaking, especially when writing plugins, you are more likely to pass a <code class="code highlight language-text">Lifetime</code> to a method than to directly add your own cleanup callbacks. When consuming services, adding items or registering callbacks, passing in a <code class="code highlight language-text">Lifetime</code> will allow that service or object to add the cleanup, removal or un-registration code for you. You should generally favour method overloads that take a <code class="code highlight language-text">Lifetime</code> over those that don’t.</p>

<p>For example, the <code class="code highlight language-text">JetBrains.Util.CollectionUtil</code> class provides several extension methods for <code class="code highlight language-text">ICollection&lt;T&gt;</code>. These methods simply call <code class="code highlight language-text">Lifetime.AddBracket</code> to immediately add the item, and will remove the item when the <code class="code highlight language-text">Lifetime</code> is terminated. This means the items only exist in the collection for the duration of the <code class="code highlight language-text">Lifetime</code>.</p>

<p>Similarly, the <code class="code highlight language-text">Threading</code> subsystem’s <code class="code highlight language-text">JetDispatcher</code> class, which can be used to dispatch actions to the main thread has an overload to the <code class="code highlight language-text">BeginInvoke</code> method which take a <code class="code highlight language-text">Lifetime</code>. This queues the given action to execute on the main thread, at some point in the near future. If you terminate the <code class="code highlight language-text">Lifetime</code>, the action is (effectively) removed from the queue, and the action isn’t executed. This is an easy way to prevent race conditions.</p>



                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper/devguide/app/js/main.build" data-baseurl="/resharper/devguide/" src="/resharper/devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

